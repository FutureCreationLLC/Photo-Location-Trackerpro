<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Photo Location Tracer Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0a192f;
    --card:#112240;
    --glass:rgba(17,34,64,0.6);
    --border:rgba(255,255,255,0.08);
    --text:#e2e8f0;
    --muted:#94a3b8;
    --accent:#64ffda;
    --accent-dark:#0a7c63;
    --radius:16px;
    --shadow:0 20px 50px rgba(0,0,0,0.4);
  }
  *{margin:0;padding:0;box-sizing:border-box}
  body{
    min-height:100vh;
    background:linear-gradient(135deg,#0a192f 0%,#020c1b 100%);
    font-family:'Inter',sans-serif;
    color:var(--text);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
    background-attachment:fixed;
  }
  .panel{
    width:100%;
    max-width:960px;
    background:var(--card);
    border-radius:var(--radius);
    overflow:hidden;
    box-shadow:var(--shadow);
    border:1px solid var(--border);
    backdrop-filter:blur(12px);
  }
  .header{
    padding:28px 32px;
    background:linear-gradient(90deg,rgba(100,255,218,0.1),rgba(100,255,218,0.05));
    border-bottom:1px solid var(--border);
    display:flex;
    align-items:center;
    gap:18px;
  }
  .logo{
    width:64px;height:64px;
    background:linear-gradient(135deg,var(--accent),var(--accent-dark));
    border-radius:16px;
    display:grid;
    place-items:center;
    font:700 28px/1 'Segoe UI',sans-serif;
    color:#0f172a;
  }
  .title h1{font-size:22px;font-weight:700;margin:0;letter-spacing:-0.5px}
  .title p{font-size:14px;color:var(--muted);margin-top:4px}
  .heart{margin-left:auto;font-size:28px;opacity:0.9}

  .body{
    display:grid;
    grid-template-columns:420px 1fr;
    gap:28px;
    padding:32px;
  }
  .controls{
    background:var(--glass);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:24px;
  }
  label{
    display:block;
    font-size:13px;
    color:var(--muted);
    margin-bottom:8px;
    font-weight:500;
  }
  input[type="file"]{
    width:100%;
    padding:14px;
    border-radius:12px;
    border:1px dashed var(--border);
    background:transparent;
    color:var(--text);
    cursor:pointer;
  }
  input[type="file"]::file-selector-button{
    background:var(--accent);
    color:#0f172a;
    border:none;
    padding:10px 16px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
    margin-right:12px;
  }
  .preview{
    margin-top:16px;
    border-radius:12px;
    overflow:hidden;
    border:1px solid var(--border);
    display:none;
  }
  .preview img{
    width:100%;
    height:auto;
    display:block;
  }
  .file-info{
    margin-top:12px;
    padding:12px;
    background:rgba(255,255,255,0.03);
    border-radius:10px;
    font-size:13px;
    color:var(--muted);
  }
  .btns{
    display:flex;
    gap:12px;
    margin-top:20px;
  }
  button{
    flex:1;
    padding:14px;
    border-radius:12px;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    transition:all 0.2s;
  }
  .primary{
    background:linear-gradient(90deg,var(--accent),#89ffdd);
    color:#0f172a;
    border:none;
  }
  .ghost{
    background:transparent;
    border:1px solid var(--border);
    color:var(--muted);
  }
  button:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }
  button:disabled::after { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--glass); }
  .loading { position: relative; }
  .loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; margin: -10px 0 0 -10px; border: 2px solid var(--accent); border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

  .result{
    background:var(--glass);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:24px;
  }
  .status{
    font-size:15px;
    margin-bottom:16px;
    font-weight:500;
  }
  .coords{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:16px;
    margin:16px 0;
  }
  .coord-row{
    background:rgba(255,255,255,0.03);
    padding:12px;
    border-radius:10px;
  }
  .label{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:0.5px}
  .value{font-size:16px;font-weight:600;margin-top:4px}
  .address{
    margin-top:20px;
    padding:16px;
    background:rgba(100,255,218,0.08);
    border-radius:12px;
    border:1px solid rgba(100,255,218,0.2);
    font-size:14px;
    line-height:1.5;
  }
  .map-container {
    margin-top: 20px;
    height: 400px;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid var(--border);
    display: none;
    position: relative;
  }
  .map-container iframe { width: 100%; height: 100%; border: 0; }
  .map-toggle {
    margin-top: 12px;
    padding: 8px 16px;
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    border-radius: 8px;
    cursor: pointer;
    font-size: 13px;
  }
  .map-toggle:hover { color: var(--accent); border-color: var(--accent); }
  .maplink{
    display:inline-block;
    margin-top:16px;
    padding:12px 20px;
    background:var(--accent);
    color:#0f172a;
    text-decoration:none;
    border-radius:12px;
    font-weight:600;
    transition:0.2s;
  }
  .maplink:hover{transform:translateY(-2px);box-shadow:0 8px 20px rgba(100,255,218,0.3)}

  .footer{
    padding:20px 32px;
    border-top:1px solid var(--border);
    display:flex;
    justify-content:space-between;
    font-size:13px;
    color:var(--muted);
  }

  @media(max-width:900px){
    .body{grid-template-columns:1fr}
    .map-container { height: 300px; }
  }
  @media(max-width:500px){
    .header{flex-direction:column;text-align:center;gap:12px}
    .heart{margin-left:0}
  }
</style>
</head>
<body>

<div class="panel">
  <div class="header">
    <div class="logo">PLT</div>
    <div class="title">
      <h1>Photo Location Tracer Pro</h1>
      <p>Extract GPS coordinates from photos • 100% private • Google Maps Powered</p>
    </div>
    
  </div>

  <div class="body">
    <div class="controls">
      <label>Upload Photo (JPEG only)</label>
      <input type="file" id="fileInput" accept="image/jpeg,image/jpg">

      <div class="preview" id="preview">
        <img id="previewImg" />
      </div>

      <div class="file-info" id="fileInfo">No file selected</div>

      <div class="btns">
        <button id="traceBtn" class="primary loading" disabled>Trace Location</button>
        <button id="clearBtn" class="ghost">Clear</button>
      </div>
    </div>

    <div class="result">
      <div class="status" id="status">Ready — upload a photo with GPS data</div>

      <div id="resultDetails" style="display:none">
        <div class="coords">
          <div class="coord-row">
            <div class="label">Latitude</div>
            <div class="value" id="lat">—</div>
          </div>
          <div class="coord-row">
            <div class="label">Longitude</div>
            <div class="value" id="lon">—</div>
          </div>
        </div>

        <div class="address" id="address">Fetching address…</div>

        <div class="map-container" id="mapContainer"></div>
        <button class="map-toggle" id="mapToggle" style="display:none">Switch to OpenStreetMap</button>

        <a id="mapLink" class="maplink" target="_blank" rel="noopener">
          Open in Google Maps
        </a>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>© <span id="year"></span> Photo Location Tracer Pro — Fully client-side</div>
    <div>Powered by Google Maps API • No images stored</div>
  </div>
</div>

<script>
// ————————————————————————————————————————
// Photo Location Tracer Pro — Google Maps Enhanced v3
// 100% client-side EXIF + Google Maps/Geocoding integration
// ————————————————————————————————————————

const GOOGLE_MAPS_API_KEY = 'YOUR_GOOGLE_MAPS_API_KEY'; // Replace with your API key
const USE_GOOGLE_MAPS = GOOGLE_MAPS_API_KEY !== 'YOUR_GOOGLE_MAPS_API_KEY';

document.getElementById('year').textContent = new Date().getFullYear();

const fileInput = document.getElementById('fileInput');
const preview = document.getElementById('preview');
const previewImg = document.getElementById('previewImg');
const fileInfo = document.getElementById('fileInfo');
const traceBtn = document.getElementById('traceBtn');
const clearBtn = document.getElementById('clearBtn');
const status = document.getElementById('status');
const resultDetails = document.getElementById('resultDetails');
const latEl = document.getElementById('lat');
const lonEl = document.getElementById('lon');
const addressEl = document.getElementById('address');
const mapContainer = document.getElementById('mapContainer');
const mapToggle = document.getElementById('mapToggle');
const mapLink = document.getElementById('mapLink');

let mapInstance = null;
let isUsingGoogle = USE_GOOGLE_MAPS;
let lastRequestTime = 0;

fileInput.addEventListener('change', () => {
  const file = fileInput.files[0];
  if (!file) {
    resetUI();
    return;
  }

  if (!file.type.includes('jpeg') && !file.name.toLowerCase().endsWith('.jpg')) {
    alert('Please select a JPEG image (.jpg or .jpeg)');
    fileInput.value = '';
    return;
  }

  fileInfo.textContent = `\( {file.name} ( \){(file.size/1024/1024).toFixed(2)} MB)`;
  traceBtn.disabled = false;
  traceBtn.classList.remove('loading');
  status.textContent = 'Ready to trace location';

  const reader = new FileReader();
  reader.onload = e => {
    previewImg.src = e.target.result;
    preview.style.display = 'block';
  };
  reader.readAsDataURL(file);
});

clearBtn.addEventListener('click', resetUI);

mapToggle.addEventListener('click', () => {
  isUsingGoogle = !isUsingGoogle;
  renderMap(latEl.dataset.lat, lonEl.dataset.lon);
  mapToggle.textContent = isUsingGoogle ? 'Switch to OpenStreetMap' : 'Switch to Google Maps';
});

traceBtn.addEventListener('click', async () => {
  const file = fileInput.files[0];
  if (!file) return;

  status.textContent = 'Reading EXIF data…';
  resultDetails.style.display = 'none';
  traceBtn.disabled = true;
  traceBtn.classList.add('loading');
  mapContainer.style.display = 'none';
  mapToggle.style.display = 'none';

  try {
    const buffer = await file.arrayBuffer();
    const exif = extractEXIF(buffer);
    const gps = parseGPS(exif);

    if (!gps || isNaN(gps.lat) || isNaN(gps.lon)) {
      status.textContent = 'No GPS data found in this photo';
      return;
    }

    status.textContent = 'Reverse geocoding location…';
    latEl.textContent = gps.lat.toFixed(6) + '°';
    lonEl.textContent = gps.lon.toFixed(6) + '°';
    latEl.dataset.lat = gps.lat;
    lonEl.dataset.lon = gps.lon;

    const address = await reverseGeocode(gps.lat, gps.lon);
    addressEl.textContent = address || 'Address not available (remote area)';

    mapLink.href = `https://www.google.com/maps?q=\( {gps.lat}, \){gps.lon}`;
    
    resultDetails.style.display = 'block';
    status.textContent = 'Location traced successfully!';
    renderMap(gps.lat, gps.lon);

  } catch (err) {
    console.error(err);
    status.textContent = 'Error processing image';
  } finally {
    traceBtn.disabled = false;
    traceBtn.classList.remove('loading');
  }
});

function resetUI() {
  fileInput.value = '';
  preview.style.display = 'none';
  previewImg.src = '';
  fileInfo.textContent = 'No file selected';
  traceBtn.disabled = true;
  traceBtn.classList.add('loading');
  status.textContent = 'Ready — upload a photo with GPS data';
  resultDetails.style.display = 'none';
  mapContainer.style.display = 'none';
  mapToggle.style.display = 'none';
  if (mapInstance) {
    mapInstance = null;
  }
  isUsingGoogle = USE_GOOGLE_MAPS;
}

// ——— Google Maps Reverse Geocoding (with fallback to OSM) ———
async function reverseGeocode(lat, lon) {
  const now = Date.now();
  if (now - lastRequestTime < 1100) {
    await new Promise(r => setTimeout(r, 1200));
  }
  lastRequestTime = Date.now();

  if (USE_GOOGLE_MAPS) {
    try {
      const res = await fetch(
        `https://maps.googleapis.com/maps/api/geocode/json?latlng=\( {lat}, \){lon}&key=${GOOGLE_MAPS_API_KEY}`,
        { headers: { 'Referer': window.location.origin } }
      );
      if (!res.ok) throw new Error('API error');
      const data = await res.json();
      return data.status === 'OK' ? data.results[0].formatted_address : 'Address lookup failed';
    } catch {
      console.warn('Google Geocoding failed, falling back to OSM');
    }
  }

  // OSM Fallback
  try {
    const res = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=\( {lat}&lon= \){lon}&zoom=18&addressdetails=1`,
      { headers: { 'User-Agent': 'PhotoLocationTracerPro/3.0 (your-email@example.com)' } }
    );
    if (!res.ok) throw new Error('API error');
    const data = await res.json();
    return data.display_name || 'Address not found';
  } catch {
    return 'Geocoding unavailable (check connection)';
  }
}

// ——— Render Map: Google JS API or OSM Embed ———
async function renderMap(lat, lon) {
  mapContainer.innerHTML = '';
  mapContainer.style.display = 'block';
  mapToggle.style.display = 'block';
  mapToggle.textContent = isUsingGoogle ? 'Switch to OpenStreetMap' : 'Switch to Google Maps';

  if (isUsingGoogle && USE_GOOGLE_MAPS) {
    if (!window.google || !window.google.maps) {
      await loadGoogleMapsScript();
    }
    if (mapInstance) {
      mapInstance.setCenter({ lat, lng: lon });
      if (mapInstance.getMarkers) mapInstance.getMarkers()[0].setPosition({ lat, lng: lon });
    } else {
      mapInstance = new window.google.maps.Map(mapContainer, {
        zoom: 17,
        center: { lat, lng: lon },
        mapTypeId: 'roadmap'
      });
      new window.google.maps.Marker({
        position: { lat, lng: lon },
        map: mapInstance,
        title: addressEl.textContent
      });
    }
  } else {
    // OSM Fallback Embed
    const iframe = document.createElement('iframe');
    iframe.src = `https://www.openstreetmap.org/export/embed.html?bbox=\( {lon-0.001}, \){lat-0.001},\( {lon+0.001}, \){lat+0.001}&layer=mapnik&marker=\( {lat}, \){lon}`;
    mapContainer.appendChild(iframe);
  }
}

// ——— Load Google Maps JS API Dynamically ———
function loadGoogleMapsScript() {
  return new Promise((resolve, reject) => {
    if (window.google && window.google.maps) {
      resolve();
      return;
    }
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&v=3.exp&libraries=geometry`;
    script.async = true;
    script.defer = true;
    script.onload = resolve;
    script.onerror = () => reject(new Error('Failed to load Google Maps'));
    document.head.appendChild(script);
  });
}

// ——— Pure client-side EXIF + GPS parser (no libraries) ———
function extractEXIF(buffer) {
  const view = new DataView(buffer);
  if (view.getUint16(0, false) !== 0xFFD8) return null; // Not JPEG

  let offset = 2;
  while (offset < buffer.byteLength) {
    const marker = view.getUint16(offset, false);
    const size = view.getUint16(offset + 2, false);
    if (marker === 0xFFE1) { // APP1 (EXIF)
      const exifStart = offset + 4;
      if (String.fromCharCode.apply(null, new Uint8Array(buffer.slice(exifStart, exifStart + 6))) === 'Exif\0\0') {
        return parseTIFF(buffer, exifStart + 6);
      }
    }
    offset += 2 + size;
  }
  return null;
}

function parseTIFF(buffer, offset) {
  const view = new DataView(buffer);
  const little = view.getUint16(offset, false) === 0x4949;
  const get16 = o => view.getUint16(o, little);
  const get32 = o => view.getUint32(o, little);

  if (get16(offset + 2) !== 0x002A) return null;
  const ifdOffset = get32(offset + 4) + offset;

  let gpsIFD = null;
  const entries = get16(ifdOffset);
  for (let i = 0; i < entries; i++) {
    const entry = ifdOffset + 2 + i * 12;
    if (get16(entry) === 0x8825) { // GPS IFD pointer
      gpsIFD = get32(entry + 8) + offset;
      break;
    }
  }

  if (!gpsIFD) return null;

  const gps = {};
  const gpsEntries = get16(gpsIFD);
  for (let i = 0; i < gpsEntries; i++) {
    const e = gpsIFD + 2 + i * 12;
    const tag = get16(e);
    gps[tag] = {
      type: get16(e + 2),
      count: get32(e + 4),
      value: get32(e + 8)
    };
  }

  return { gps, little, base: offset, buffer };
}

function parseGPS(exif) {
  if (!exif || !exif.gps) return null;
  const g = exif.gps;
  const view = new DataView(exif.buffer);
  const little = exif.little;
  const base = exif.base;

  const toDeg = (tag) => {
    if (!g[tag]) return 0;
    const off = g[tag].value + base;
    const d = view.getUint32(off, little) / view.getUint32(off + 4, little);
    const m = view.getUint32(off + 8, little) / view.getUint32(off + 12, little);
    const s = view.getUint32(off + 16, little) / view.getUint32(off + 20, little);
    return d + m/60 + s/3600;
  };

  const lat = toDeg(2); // Latitude
  const lon = toDeg(4); // Longitude
  const latRef = g[1] ? String.fromCharCode(view.getUint8(g[1].value + base)) : 'N';
  const lonRef = g[3] ? String.fromCharCode(view.getUint8(g[3].value + base)) : 'E';

  return {
    lat: latRef === 'S' ? -lat : lat,
    lon: lonRef === 'W' ? -lon : lon
  };
}
</script>
</body>
</html>
